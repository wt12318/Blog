---
title: dplyr基础
author: wutao
date: '2021-01-20'
slug: dplyr_base
categories:
  - R
  - reading notes
tags:
  - R
image : "dplyr.png"
---

<script src="/rmarkdown-libs/header-attrs/header-attrs.js"></script>


<p>参考： <a href="https://github.com/tidyverse/dplyr/blob/master/vignettes/base.Rmd">dplyr base</a> <a href="https://github.com/tidyverse/dplyr/blob/master/vignettes/two-table.Rmd">two table</a></p>
<p>这篇文章主要比较dplyr函数和base R的区别</p>
<div id="overview" class="section level2">
<h2>Overview</h2>
<ol style="list-style-type: decimal">
<li>dplyr动词输入和输出都是数据框，而base R大部分是单独的向量  <br />
</li>
<li>dplyr依赖非标准计算，所以不需要$来选择变量(列)</li>
<li>dplyr使用一系列具有单个目的的动词，而在baseR中通常使用[]</li>
<li>dplyr的动词通常可以通过管道(%&gt;%)连在一起，而baseR中常常需要将中间结果保存为变量</li>
<li>所有的dplyr动词都可以处理分组数据并且和处理整个数据框类似，但是在baseR中可能每个组的处理都有着不同的形式</li>
</ol>
</div>
<div id="one-table-verbs" class="section level2">
<h2>One table verbs</h2>
<table>
<thead>
<tr class="header">
<th>dplyr</th>
<th>base</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td><code>arrange(df, x)</code></td>
<td><code>df[order(x), , drop = FALSE]</code></td>
</tr>
<tr class="even">
<td><code>distinct(df, x)</code></td>
<td><code>df[!duplicated(x), , drop = FALSE]</code>, <code>unique()</code></td>
</tr>
<tr class="odd">
<td><code>filter(df, x)</code></td>
<td><code>df[which(x), , drop = FALSE]</code>, <code>subset()</code></td>
</tr>
<tr class="even">
<td><code>mutate(df, z = x + y)</code></td>
<td><code>df$z &lt;- df$x + df$y</code>, <code>transform()</code></td>
</tr>
<tr class="odd">
<td><code>pull(df, 1)</code></td>
<td><code>df[[1]]</code></td>
</tr>
<tr class="even">
<td><code>pull(df, x)</code></td>
<td><code>df$x</code></td>
</tr>
<tr class="odd">
<td><code>rename(df, y = x)</code></td>
<td><code>names(df)[names(df) == "x"] &lt;- "y"</code></td>
</tr>
<tr class="even">
<td><code>relocate(df, y)</code></td>
<td><code>df[union("y", names(df))]</code></td>
</tr>
<tr class="odd">
<td><code>select(df, x, y)</code></td>
<td><code>df[c("x", "y")]</code>, <code>subset()</code></td>
</tr>
<tr class="even">
<td><code>select(df, starts_with("x")</code></td>
<td><code>df[grepl(names(df), "^x")]</code></td>
</tr>
<tr class="odd">
<td><code>summarise(df, mean(x))</code></td>
<td><code>mean(df$x)</code>, <code>tapply()</code>, <code>aggregate()</code>, <code>by()</code></td>
</tr>
<tr class="even">
<td><code>slice(df, c(1, 2, 5))</code></td>
<td><code>df[c(1, 2, 5), , drop = FALSE]</code></td>
</tr>
</tbody>
</table>
<p>首先载入示例数据：</p>
<pre class="r"><code>library(dplyr)
&gt;&gt; Warning: 程辑包&#39;dplyr&#39;是用R版本3.6.3 来建造的
&gt;&gt; 
&gt;&gt; 载入程辑包：&#39;dplyr&#39;
&gt;&gt; The following objects are masked from &#39;package:stats&#39;:
&gt;&gt; 
&gt;&gt;     filter, lag
&gt;&gt; The following objects are masked from &#39;package:base&#39;:
&gt;&gt; 
&gt;&gt;     intersect, setdiff, setequal, union

mtcars &lt;- as_tibble(mtcars)
iris &lt;- as_tibble(iris)</code></pre>
<div id="arrange-通过变量来组织行" class="section level3">
<h3><code>arrange()</code> 通过变量来组织行</h3>
<p><code>dplyr::arrange()</code>通过一列或多列的值来对数据框的行进行排序：</p>
<pre class="r"><code>mtcars %&gt;% arrange(cyl,disp)
&gt;&gt; # A tibble: 32 x 11
&gt;&gt;      mpg   cyl  disp    hp  drat    wt  qsec    vs    am  gear  carb
&gt;&gt;    &lt;dbl&gt; &lt;dbl&gt; &lt;dbl&gt; &lt;dbl&gt; &lt;dbl&gt; &lt;dbl&gt; &lt;dbl&gt; &lt;dbl&gt; &lt;dbl&gt; &lt;dbl&gt; &lt;dbl&gt;
&gt;&gt;  1  33.9     4  71.1    65  4.22  1.84  19.9     1     1     4     1
&gt;&gt;  2  30.4     4  75.7    52  4.93  1.62  18.5     1     1     4     2
&gt;&gt;  3  32.4     4  78.7    66  4.08  2.2   19.5     1     1     4     1
&gt;&gt;  4  27.3     4  79      66  4.08  1.94  18.9     1     1     4     1
&gt;&gt;  5  30.4     4  95.1   113  3.77  1.51  16.9     1     1     5     2
&gt;&gt;  6  22.8     4 108      93  3.85  2.32  18.6     1     1     4     1
&gt;&gt;  7  21.5     4 120.     97  3.7   2.46  20.0     1     0     3     1
&gt;&gt;  8  26       4 120.     91  4.43  2.14  16.7     0     1     5     2
&gt;&gt;  9  21.4     4 121     109  4.11  2.78  18.6     1     1     4     2
&gt;&gt; 10  22.8     4 141.     95  3.92  3.15  22.9     1     0     4     2
&gt;&gt; # ... with 22 more rows</code></pre>
<p><code>desc()</code>辅助函数可以进行降序排序：</p>
<pre class="r"><code>mtcars %&gt;% arrange(desc(cyl),desc(disp))
&gt;&gt; # A tibble: 32 x 11
&gt;&gt;      mpg   cyl  disp    hp  drat    wt  qsec    vs    am  gear  carb
&gt;&gt;    &lt;dbl&gt; &lt;dbl&gt; &lt;dbl&gt; &lt;dbl&gt; &lt;dbl&gt; &lt;dbl&gt; &lt;dbl&gt; &lt;dbl&gt; &lt;dbl&gt; &lt;dbl&gt; &lt;dbl&gt;
&gt;&gt;  1  10.4     8   472   205  2.93  5.25  18.0     0     0     3     4
&gt;&gt;  2  10.4     8   460   215  3     5.42  17.8     0     0     3     4
&gt;&gt;  3  14.7     8   440   230  3.23  5.34  17.4     0     0     3     4
&gt;&gt;  4  19.2     8   400   175  3.08  3.84  17.0     0     0     3     2
&gt;&gt;  5  18.7     8   360   175  3.15  3.44  17.0     0     0     3     2
&gt;&gt;  6  14.3     8   360   245  3.21  3.57  15.8     0     0     3     4
&gt;&gt;  7  15.8     8   351   264  4.22  3.17  14.5     0     1     5     4
&gt;&gt;  8  13.3     8   350   245  3.73  3.84  15.4     0     0     3     4
&gt;&gt;  9  15.5     8   318   150  2.76  3.52  16.9     0     0     3     2
&gt;&gt; 10  15.2     8   304   150  3.15  3.44  17.3     0     0     3     2
&gt;&gt; # ... with 22 more rows</code></pre>
<p>在base R中可以使用[+order函数对行进行排序：</p>
<pre class="r"><code>mtcars[order(mtcars$cyl,mtcars$disp),,drop= FALSE]
&gt;&gt; # A tibble: 32 x 11
&gt;&gt;      mpg   cyl  disp    hp  drat    wt  qsec    vs    am  gear  carb
&gt;&gt;    &lt;dbl&gt; &lt;dbl&gt; &lt;dbl&gt; &lt;dbl&gt; &lt;dbl&gt; &lt;dbl&gt; &lt;dbl&gt; &lt;dbl&gt; &lt;dbl&gt; &lt;dbl&gt; &lt;dbl&gt;
&gt;&gt;  1  33.9     4  71.1    65  4.22  1.84  19.9     1     1     4     1
&gt;&gt;  2  30.4     4  75.7    52  4.93  1.62  18.5     1     1     4     2
&gt;&gt;  3  32.4     4  78.7    66  4.08  2.2   19.5     1     1     4     1
&gt;&gt;  4  27.3     4  79      66  4.08  1.94  18.9     1     1     4     1
&gt;&gt;  5  30.4     4  95.1   113  3.77  1.51  16.9     1     1     5     2
&gt;&gt;  6  22.8     4 108      93  3.85  2.32  18.6     1     1     4     1
&gt;&gt;  7  21.5     4 120.     97  3.7   2.46  20.0     1     0     3     1
&gt;&gt;  8  26       4 120.     91  4.43  2.14  16.7     0     1     5     2
&gt;&gt;  9  21.4     4 121     109  4.11  2.78  18.6     1     1     4     2
&gt;&gt; 10  22.8     4 141.     95  3.92  3.15  22.9     1     0     4     2
&gt;&gt; # ... with 22 more rows</code></pre>
<p>记得加上drop= FALSE，不然如果输入是只有一列的数据框，输出就是一个向量而不是数据框了：</p>
<pre class="r"><code>dt &lt;- data.frame(
  x = c(1,2,3)
)

dt[order(dt$x),]
&gt;&gt; [1] 1 2 3
dt[order(dt$x),,drop=FALSE]
&gt;&gt;   x
&gt;&gt; 1 1
&gt;&gt; 2 2
&gt;&gt; 3 3</code></pre>
<p>进行倒序排序，base R有两种选择：</p>
<ul>
<li><p>对于数值变量可以加上负号-</p></li>
<li><p>在order函数中指定参数decreasing=TRUE</p></li>
</ul>
<pre class="r"><code>mtcars[order(mtcars$cyl, mtcars$disp, decreasing = TRUE), , drop = FALSE]
&gt;&gt; # A tibble: 32 x 11
&gt;&gt;      mpg   cyl  disp    hp  drat    wt  qsec    vs    am  gear  carb
&gt;&gt;    &lt;dbl&gt; &lt;dbl&gt; &lt;dbl&gt; &lt;dbl&gt; &lt;dbl&gt; &lt;dbl&gt; &lt;dbl&gt; &lt;dbl&gt; &lt;dbl&gt; &lt;dbl&gt; &lt;dbl&gt;
&gt;&gt;  1  10.4     8   472   205  2.93  5.25  18.0     0     0     3     4
&gt;&gt;  2  10.4     8   460   215  3     5.42  17.8     0     0     3     4
&gt;&gt;  3  14.7     8   440   230  3.23  5.34  17.4     0     0     3     4
&gt;&gt;  4  19.2     8   400   175  3.08  3.84  17.0     0     0     3     2
&gt;&gt;  5  18.7     8   360   175  3.15  3.44  17.0     0     0     3     2
&gt;&gt;  6  14.3     8   360   245  3.21  3.57  15.8     0     0     3     4
&gt;&gt;  7  15.8     8   351   264  4.22  3.17  14.5     0     1     5     4
&gt;&gt;  8  13.3     8   350   245  3.73  3.84  15.4     0     0     3     4
&gt;&gt;  9  15.5     8   318   150  2.76  3.52  16.9     0     0     3     2
&gt;&gt; 10  15.2     8   304   150  3.15  3.44  17.3     0     0     3     2
&gt;&gt; # ... with 22 more rows

###or
mtcars[order(-mtcars$cyl, -mtcars$disp), , drop = FALSE]
&gt;&gt; # A tibble: 32 x 11
&gt;&gt;      mpg   cyl  disp    hp  drat    wt  qsec    vs    am  gear  carb
&gt;&gt;    &lt;dbl&gt; &lt;dbl&gt; &lt;dbl&gt; &lt;dbl&gt; &lt;dbl&gt; &lt;dbl&gt; &lt;dbl&gt; &lt;dbl&gt; &lt;dbl&gt; &lt;dbl&gt; &lt;dbl&gt;
&gt;&gt;  1  10.4     8   472   205  2.93  5.25  18.0     0     0     3     4
&gt;&gt;  2  10.4     8   460   215  3     5.42  17.8     0     0     3     4
&gt;&gt;  3  14.7     8   440   230  3.23  5.34  17.4     0     0     3     4
&gt;&gt;  4  19.2     8   400   175  3.08  3.84  17.0     0     0     3     2
&gt;&gt;  5  18.7     8   360   175  3.15  3.44  17.0     0     0     3     2
&gt;&gt;  6  14.3     8   360   245  3.21  3.57  15.8     0     0     3     4
&gt;&gt;  7  15.8     8   351   264  4.22  3.17  14.5     0     1     5     4
&gt;&gt;  8  13.3     8   350   245  3.73  3.84  15.4     0     0     3     4
&gt;&gt;  9  15.5     8   318   150  2.76  3.52  16.9     0     0     3     2
&gt;&gt; 10  15.2     8   304   150  3.15  3.44  17.3     0     0     3     2
&gt;&gt; # ... with 22 more rows</code></pre>
</div>
<div id="distinct选择唯一的行" class="section level3">
<h3><code>distinct()</code>:选择唯一的行</h3>
<p><code>dplyr::distinct()</code>选择唯一的行:</p>
<pre class="r"><code>df &lt;- tibble(
  x = sample(10, 100, rep = TRUE),
  y = sample(10, 100, rep = TRUE)
)

df %&gt;% distinct(x)
&gt;&gt; # A tibble: 10 x 1
&gt;&gt;        x
&gt;&gt;    &lt;int&gt;
&gt;&gt;  1    10
&gt;&gt;  2     8
&gt;&gt;  3     9
&gt;&gt;  4     4
&gt;&gt;  5     7
&gt;&gt;  6     5
&gt;&gt;  7     3
&gt;&gt;  8     1
&gt;&gt;  9     6
&gt;&gt; 10     2

###使用.keep_all保留其他的列
df %&gt;% distinct(x,.keep_all = TRUE)
&gt;&gt; # A tibble: 10 x 2
&gt;&gt;        x     y
&gt;&gt;    &lt;int&gt; &lt;int&gt;
&gt;&gt;  1    10     3
&gt;&gt;  2     8     1
&gt;&gt;  3     9     3
&gt;&gt;  4     4     7
&gt;&gt;  5     7     9
&gt;&gt;  6     5     3
&gt;&gt;  7     3     3
&gt;&gt;  8     1     1
&gt;&gt;  9     6     3
&gt;&gt; 10     2     4</code></pre>
<p>在base R中基于想要选择的列还是全部的数据框也有两种实现方法：</p>
<pre class="r"><code>unique(df[&quot;x&quot;])
&gt;&gt; # A tibble: 10 x 1
&gt;&gt;        x
&gt;&gt;    &lt;int&gt;
&gt;&gt;  1    10
&gt;&gt;  2     8
&gt;&gt;  3     9
&gt;&gt;  4     4
&gt;&gt;  5     7
&gt;&gt;  6     5
&gt;&gt;  7     3
&gt;&gt;  8     1
&gt;&gt;  9     6
&gt;&gt; 10     2

df[!duplicated(df$x), , drop = FALSE]
&gt;&gt; # A tibble: 10 x 2
&gt;&gt;        x     y
&gt;&gt;    &lt;int&gt; &lt;int&gt;
&gt;&gt;  1    10     3
&gt;&gt;  2     8     1
&gt;&gt;  3     9     3
&gt;&gt;  4     4     7
&gt;&gt;  5     7     9
&gt;&gt;  6     5     3
&gt;&gt;  7     3     3
&gt;&gt;  8     1     1
&gt;&gt;  9     6     3
&gt;&gt; 10     2     4</code></pre>
</div>
<div id="filter返回符合条件的行" class="section level3">
<h3><code>filter()</code>返回符合条件的行</h3>
<p><code>dplyr::filter()</code> 返回表达式是TRUE的行</p>
<pre class="r"><code>starwars %&gt;% filter(species == &quot;Human&quot;)
&gt;&gt; # A tibble: 35 x 14
&gt;&gt;    name  height  mass hair_color skin_color eye_color birth_year sex   gender
&gt;&gt;    &lt;chr&gt;  &lt;int&gt; &lt;dbl&gt; &lt;chr&gt;      &lt;chr&gt;      &lt;chr&gt;          &lt;dbl&gt; &lt;chr&gt; &lt;chr&gt; 
&gt;&gt;  1 Luke~    172    77 blond      fair       blue            19   male  mascu~
&gt;&gt;  2 Dart~    202   136 none       white      yellow          41.9 male  mascu~
&gt;&gt;  3 Leia~    150    49 brown      light      brown           19   fema~ femin~
&gt;&gt;  4 Owen~    178   120 brown, gr~ light      blue            52   male  mascu~
&gt;&gt;  5 Beru~    165    75 brown      light      blue            47   fema~ femin~
&gt;&gt;  6 Bigg~    183    84 black      light      brown           24   male  mascu~
&gt;&gt;  7 Obi-~    182    77 auburn, w~ fair       blue-gray       57   male  mascu~
&gt;&gt;  8 Anak~    188    84 blond      fair       blue            41.9 male  mascu~
&gt;&gt;  9 Wilh~    180    NA auburn, g~ fair       blue            64   male  mascu~
&gt;&gt; 10 Han ~    180    80 brown      fair       brown           29   male  mascu~
&gt;&gt; # ... with 25 more rows, and 5 more variables: homeworld &lt;chr&gt;, species &lt;chr&gt;,
&gt;&gt; #   films &lt;list&gt;, vehicles &lt;list&gt;, starships &lt;list&gt;

starwars %&gt;% filter(mass &gt; 1000)
&gt;&gt; # A tibble: 1 x 14
&gt;&gt;   name  height  mass hair_color skin_color eye_color birth_year sex   gender
&gt;&gt;   &lt;chr&gt;  &lt;int&gt; &lt;dbl&gt; &lt;chr&gt;      &lt;chr&gt;      &lt;chr&gt;          &lt;dbl&gt; &lt;chr&gt; &lt;chr&gt; 
&gt;&gt; 1 Jabb~    175  1358 &lt;NA&gt;       green-tan~ orange           600 herm~ mascu~
&gt;&gt; # ... with 5 more variables: homeworld &lt;chr&gt;, species &lt;chr&gt;, films &lt;list&gt;,
&gt;&gt; #   vehicles &lt;list&gt;, starships &lt;list&gt;

starwars %&gt;% filter(hair_color == &quot;none&quot; &amp; eye_color == &quot;black&quot;)
&gt;&gt; # A tibble: 9 x 14
&gt;&gt;   name  height  mass hair_color skin_color eye_color birth_year sex   gender
&gt;&gt;   &lt;chr&gt;  &lt;int&gt; &lt;dbl&gt; &lt;chr&gt;      &lt;chr&gt;      &lt;chr&gt;          &lt;dbl&gt; &lt;chr&gt; &lt;chr&gt; 
&gt;&gt; 1 Nien~    160    68 none       grey       black             NA male  mascu~
&gt;&gt; 2 Gasg~    122    NA none       white, bl~ black             NA male  mascu~
&gt;&gt; 3 Kit ~    196    87 none       green      black             NA male  mascu~
&gt;&gt; 4 Plo ~    188    80 none       orange     black             22 male  mascu~
&gt;&gt; 5 Lama~    229    88 none       grey       black             NA male  mascu~
&gt;&gt; 6 Taun~    213    NA none       grey       black             NA fema~ femin~
&gt;&gt; 7 Shaa~    178    57 none       red, blue~ black             NA fema~ femin~
&gt;&gt; 8 Tion~    206    80 none       grey       black             NA male  mascu~
&gt;&gt; 9 BB8       NA    NA none       none       black             NA none  mascu~
&gt;&gt; # ... with 5 more variables: homeworld &lt;chr&gt;, species &lt;chr&gt;, films &lt;list&gt;,
&gt;&gt; #   vehicles &lt;list&gt;, starships &lt;list&gt;</code></pre>
<p>在baseR中有相似功能的函数是subset</p>
<pre class="r"><code>subset(starwars, species == &quot;Human&quot;)
&gt;&gt; # A tibble: 35 x 14
&gt;&gt;    name  height  mass hair_color skin_color eye_color birth_year sex   gender
&gt;&gt;    &lt;chr&gt;  &lt;int&gt; &lt;dbl&gt; &lt;chr&gt;      &lt;chr&gt;      &lt;chr&gt;          &lt;dbl&gt; &lt;chr&gt; &lt;chr&gt; 
&gt;&gt;  1 Luke~    172    77 blond      fair       blue            19   male  mascu~
&gt;&gt;  2 Dart~    202   136 none       white      yellow          41.9 male  mascu~
&gt;&gt;  3 Leia~    150    49 brown      light      brown           19   fema~ femin~
&gt;&gt;  4 Owen~    178   120 brown, gr~ light      blue            52   male  mascu~
&gt;&gt;  5 Beru~    165    75 brown      light      blue            47   fema~ femin~
&gt;&gt;  6 Bigg~    183    84 black      light      brown           24   male  mascu~
&gt;&gt;  7 Obi-~    182    77 auburn, w~ fair       blue-gray       57   male  mascu~
&gt;&gt;  8 Anak~    188    84 blond      fair       blue            41.9 male  mascu~
&gt;&gt;  9 Wilh~    180    NA auburn, g~ fair       blue            64   male  mascu~
&gt;&gt; 10 Han ~    180    80 brown      fair       brown           29   male  mascu~
&gt;&gt; # ... with 25 more rows, and 5 more variables: homeworld &lt;chr&gt;, species &lt;chr&gt;,
&gt;&gt; #   films &lt;list&gt;, vehicles &lt;list&gt;, starships &lt;list&gt;</code></pre>
<p>也可以使用[来选择行：</p>
<pre class="r"><code>starwars[starwars$species == &quot;Human&quot;,]
&gt;&gt; # A tibble: 39 x 14
&gt;&gt;    name  height  mass hair_color skin_color eye_color birth_year sex   gender
&gt;&gt;    &lt;chr&gt;  &lt;int&gt; &lt;dbl&gt; &lt;chr&gt;      &lt;chr&gt;      &lt;chr&gt;          &lt;dbl&gt; &lt;chr&gt; &lt;chr&gt; 
&gt;&gt;  1 Luke~    172    77 blond      fair       blue            19   male  mascu~
&gt;&gt;  2 Dart~    202   136 none       white      yellow          41.9 male  mascu~
&gt;&gt;  3 Leia~    150    49 brown      light      brown           19   fema~ femin~
&gt;&gt;  4 Owen~    178   120 brown, gr~ light      blue            52   male  mascu~
&gt;&gt;  5 Beru~    165    75 brown      light      blue            47   fema~ femin~
&gt;&gt;  6 Bigg~    183    84 black      light      brown           24   male  mascu~
&gt;&gt;  7 Obi-~    182    77 auburn, w~ fair       blue-gray       57   male  mascu~
&gt;&gt;  8 Anak~    188    84 blond      fair       blue            41.9 male  mascu~
&gt;&gt;  9 Wilh~    180    NA auburn, g~ fair       blue            64   male  mascu~
&gt;&gt; 10 Han ~    180    80 brown      fair       brown           29   male  mascu~
&gt;&gt; # ... with 29 more rows, and 5 more variables: homeworld &lt;chr&gt;, species &lt;chr&gt;,
&gt;&gt; #   films &lt;list&gt;, vehicles &lt;list&gt;, starships &lt;list&gt;</code></pre>
<p>但是这样处理会出现NA的情况，为了避免NA，可以结合使用which：</p>
<pre class="r"><code>starwars[which(starwars$species == &quot;Human&quot;), , drop = FALSE]
&gt;&gt; # A tibble: 35 x 14
&gt;&gt;    name  height  mass hair_color skin_color eye_color birth_year sex   gender
&gt;&gt;    &lt;chr&gt;  &lt;int&gt; &lt;dbl&gt; &lt;chr&gt;      &lt;chr&gt;      &lt;chr&gt;          &lt;dbl&gt; &lt;chr&gt; &lt;chr&gt; 
&gt;&gt;  1 Luke~    172    77 blond      fair       blue            19   male  mascu~
&gt;&gt;  2 Dart~    202   136 none       white      yellow          41.9 male  mascu~
&gt;&gt;  3 Leia~    150    49 brown      light      brown           19   fema~ femin~
&gt;&gt;  4 Owen~    178   120 brown, gr~ light      blue            52   male  mascu~
&gt;&gt;  5 Beru~    165    75 brown      light      blue            47   fema~ femin~
&gt;&gt;  6 Bigg~    183    84 black      light      brown           24   male  mascu~
&gt;&gt;  7 Obi-~    182    77 auburn, w~ fair       blue-gray       57   male  mascu~
&gt;&gt;  8 Anak~    188    84 blond      fair       blue            41.9 male  mascu~
&gt;&gt;  9 Wilh~    180    NA auburn, g~ fair       blue            64   male  mascu~
&gt;&gt; 10 Han ~    180    80 brown      fair       brown           29   male  mascu~
&gt;&gt; # ... with 25 more rows, and 5 more variables: homeworld &lt;chr&gt;, species &lt;chr&gt;,
&gt;&gt; #   films &lt;list&gt;, vehicles &lt;list&gt;, starships &lt;list&gt;</code></pre>
</div>
<div id="mutate创建或转化变量" class="section level3">
<h3><code>mutate()</code>创建或转化变量</h3>
<p><code>dplyr::mutate</code>从已存在的变量中创建新的变量</p>
<pre class="r"><code>df %&gt;% mutate(z = x + y, z2 = z ^ 2)
&gt;&gt; # A tibble: 100 x 4
&gt;&gt;        x     y     z    z2
&gt;&gt;    &lt;int&gt; &lt;int&gt; &lt;int&gt; &lt;dbl&gt;
&gt;&gt;  1    10     3    13   169
&gt;&gt;  2     8     1     9    81
&gt;&gt;  3     9     3    12   144
&gt;&gt;  4    10     6    16   256
&gt;&gt;  5     9     3    12   144
&gt;&gt;  6     4     7    11   121
&gt;&gt;  7    10    10    20   400
&gt;&gt;  8     7     9    16   256
&gt;&gt;  9     4     1     5    25
&gt;&gt; 10     5     3     8    64
&gt;&gt; # ... with 90 more rows</code></pre>
<p>在base R里面相似的有transform函数，但是要注意的是transform函数不能使用刚创建的变量，只能使用已有的变量：</p>
<pre class="r"><code>head(transform(df,z=x+y,z2=z^2))
&gt;&gt; Error in eval(substitute(list(...)), `_data`, parent.frame()): 找不到对象&#39;z&#39;

head(transform(df,z=x+y,z2=(x+y)^2))
&gt;&gt;    x y  z  z2
&gt;&gt; 1 10 3 13 169
&gt;&gt; 2  8 1  9  81
&gt;&gt; 3  9 3 12 144
&gt;&gt; 4 10 6 16 256
&gt;&gt; 5  9 3 12 144
&gt;&gt; 6  4 7 11 121</code></pre>
<p>也可以使用<code>$&lt;-</code>来创建新的变量：</p>
<pre class="r"><code>mtcars$cy12 &lt;- mtcars$cyl * 2
mtcars$cy14 &lt;- mtcars$cy12 *2</code></pre>
<p>当应用到分组的数据框上，mutate可以对每个组别计算新的变量：</p>
<pre class="r"><code>gf &lt;- tibble(g = c(1, 1, 2, 2), x = c(0.5, 1.5, 2.5, 3.5))
gf %&gt;% 
  group_by(g) %&gt;% 
  mutate(x_mean = mean(x), x_rank = rank(x))
&gt;&gt; # A tibble: 4 x 4
&gt;&gt; # Groups:   g [2]
&gt;&gt;       g     x x_mean x_rank
&gt;&gt;   &lt;dbl&gt; &lt;dbl&gt;  &lt;dbl&gt;  &lt;dbl&gt;
&gt;&gt; 1     1   0.5      1      1
&gt;&gt; 2     1   1.5      1      2
&gt;&gt; 3     2   2.5      3      1
&gt;&gt; 4     2   3.5      3      2</code></pre>
<p>在baseR中可以用使用<code>ave</code>函数</p>
<pre class="r"><code>transform(gf, 
  x_mean = ave(x, g, FUN = mean), 
  x_rank = ave(x, g, FUN = rank)
)
&gt;&gt;   g   x x_mean x_rank
&gt;&gt; 1 1 0.5      1      1
&gt;&gt; 2 1 1.5      1      2
&gt;&gt; 3 2 2.5      3      1
&gt;&gt; 4 2 3.5      3      2</code></pre>
</div>
<div id="pull-抽提变量" class="section level3">
<h3><code>pull()</code> 抽提变量</h3>
<p><code>dplyr::pull()</code>可以通过名称或者位置提取变量：</p>
<pre class="r"><code>mtcars %&gt;% pull(1)
&gt;&gt;  [1] 21.0 21.0 22.8 21.4 18.7 18.1 14.3 24.4 22.8 19.2 17.8 16.4 17.3 15.2 10.4
&gt;&gt; [16] 10.4 14.7 32.4 30.4 33.9 21.5 15.5 15.2 13.3 19.2 27.3 26.0 30.4 15.8 19.7
&gt;&gt; [31] 15.0 21.4

mtcars %&gt;% pull(cyl)
&gt;&gt;  [1] 6 6 4 6 8 6 8 4 4 6 6 8 8 8 8 8 8 4 4 4 4 8 8 8 8 4 4 4 8 6 8 4</code></pre>
<p>在base R中相当于[[和$:</p>
<pre class="r"><code>mtcars[[&quot;cyl&quot;]]
&gt;&gt;  [1] 6 6 4 6 8 6 8 4 4 6 6 8 8 8 8 8 8 4 4 4 4 8 8 8 8 4 4 4 8 6 8 4
mtcars[[1]]
&gt;&gt;  [1] 21.0 21.0 22.8 21.4 18.7 18.1 14.3 24.4 22.8 19.2 17.8 16.4 17.3 15.2 10.4
&gt;&gt; [16] 10.4 14.7 32.4 30.4 33.9 21.5 15.5 15.2 13.3 19.2 27.3 26.0 30.4 15.8 19.7
&gt;&gt; [31] 15.0 21.4

mtcars$cyl
&gt;&gt;  [1] 6 6 4 6 8 6 8 4 4 6 6 8 8 8 8 8 8 4 4 4 4 8 8 8 8 4 4 4 8 6 8 4</code></pre>
</div>
<div id="relocate-改变列的顺序" class="section level3">
<h3><code>relocate()</code> 改变列的顺序</h3>
<p><code>dplyr::relocate()</code> 可以方便的将列移到新的位置(默认是最前面,下面要讲的<code>select</code>只能将列移到最前面):</p>
<pre class="r"><code># to front
mtcars %&gt;% relocate(gear, carb) 
&gt;&gt; # A tibble: 32 x 13
&gt;&gt;     gear  carb   mpg   cyl  disp    hp  drat    wt  qsec    vs    am  cy12  cy14
&gt;&gt;    &lt;dbl&gt; &lt;dbl&gt; &lt;dbl&gt; &lt;dbl&gt; &lt;dbl&gt; &lt;dbl&gt; &lt;dbl&gt; &lt;dbl&gt; &lt;dbl&gt; &lt;dbl&gt; &lt;dbl&gt; &lt;dbl&gt; &lt;dbl&gt;
&gt;&gt;  1     4     4  21       6  160    110  3.9   2.62  16.5     0     1    12    24
&gt;&gt;  2     4     4  21       6  160    110  3.9   2.88  17.0     0     1    12    24
&gt;&gt;  3     4     1  22.8     4  108     93  3.85  2.32  18.6     1     1     8    16
&gt;&gt;  4     3     1  21.4     6  258    110  3.08  3.22  19.4     1     0    12    24
&gt;&gt;  5     3     2  18.7     8  360    175  3.15  3.44  17.0     0     0    16    32
&gt;&gt;  6     3     1  18.1     6  225    105  2.76  3.46  20.2     1     0    12    24
&gt;&gt;  7     3     4  14.3     8  360    245  3.21  3.57  15.8     0     0    16    32
&gt;&gt;  8     4     2  24.4     4  147.    62  3.69  3.19  20       1     0     8    16
&gt;&gt;  9     4     2  22.8     4  141.    95  3.92  3.15  22.9     1     0     8    16
&gt;&gt; 10     4     4  19.2     6  168.   123  3.92  3.44  18.3     1     0    12    24
&gt;&gt; # ... with 22 more rows

# to back
mtcars %&gt;% relocate(mpg, cyl, .after = last_col()) 
&gt;&gt; # A tibble: 32 x 13
&gt;&gt;     disp    hp  drat    wt  qsec    vs    am  gear  carb  cy12  cy14   mpg   cyl
&gt;&gt;    &lt;dbl&gt; &lt;dbl&gt; &lt;dbl&gt; &lt;dbl&gt; &lt;dbl&gt; &lt;dbl&gt; &lt;dbl&gt; &lt;dbl&gt; &lt;dbl&gt; &lt;dbl&gt; &lt;dbl&gt; &lt;dbl&gt; &lt;dbl&gt;
&gt;&gt;  1  160    110  3.9   2.62  16.5     0     1     4     4    12    24  21       6
&gt;&gt;  2  160    110  3.9   2.88  17.0     0     1     4     4    12    24  21       6
&gt;&gt;  3  108     93  3.85  2.32  18.6     1     1     4     1     8    16  22.8     4
&gt;&gt;  4  258    110  3.08  3.22  19.4     1     0     3     1    12    24  21.4     6
&gt;&gt;  5  360    175  3.15  3.44  17.0     0     0     3     2    16    32  18.7     8
&gt;&gt;  6  225    105  2.76  3.46  20.2     1     0     3     1    12    24  18.1     6
&gt;&gt;  7  360    245  3.21  3.57  15.8     0     0     3     4    16    32  14.3     8
&gt;&gt;  8  147.    62  3.69  3.19  20       1     0     4     2     8    16  24.4     4
&gt;&gt;  9  141.    95  3.92  3.15  22.9     1     0     4     2     8    16  22.8     4
&gt;&gt; 10  168.   123  3.92  3.44  18.3     1     0     4     4    12    24  19.2     6
&gt;&gt; # ... with 22 more rows

# to after disp
mtcars %&gt;% relocate(mpg, cyl, .after = disp) 
&gt;&gt; # A tibble: 32 x 13
&gt;&gt;     disp   mpg   cyl    hp  drat    wt  qsec    vs    am  gear  carb  cy12  cy14
&gt;&gt;    &lt;dbl&gt; &lt;dbl&gt; &lt;dbl&gt; &lt;dbl&gt; &lt;dbl&gt; &lt;dbl&gt; &lt;dbl&gt; &lt;dbl&gt; &lt;dbl&gt; &lt;dbl&gt; &lt;dbl&gt; &lt;dbl&gt; &lt;dbl&gt;
&gt;&gt;  1  160   21       6   110  3.9   2.62  16.5     0     1     4     4    12    24
&gt;&gt;  2  160   21       6   110  3.9   2.88  17.0     0     1     4     4    12    24
&gt;&gt;  3  108   22.8     4    93  3.85  2.32  18.6     1     1     4     1     8    16
&gt;&gt;  4  258   21.4     6   110  3.08  3.22  19.4     1     0     3     1    12    24
&gt;&gt;  5  360   18.7     8   175  3.15  3.44  17.0     0     0     3     2    16    32
&gt;&gt;  6  225   18.1     6   105  2.76  3.46  20.2     1     0     3     1    12    24
&gt;&gt;  7  360   14.3     8   245  3.21  3.57  15.8     0     0     3     4    16    32
&gt;&gt;  8  147.  24.4     4    62  3.69  3.19  20       1     0     4     2     8    16
&gt;&gt;  9  141.  22.8     4    95  3.92  3.15  22.9     1     0     4     2     8    16
&gt;&gt; 10  168.  19.2     6   123  3.92  3.44  18.3     1     0     4     4    12    24
&gt;&gt; # ... with 22 more rows</code></pre>
<p>在base R中就有一点复杂：</p>
<pre class="r"><code>##to front
mtcars[union(c(&quot;gear&quot;, &quot;carb&quot;), names(mtcars))]
&gt;&gt; # A tibble: 32 x 13
&gt;&gt;     gear  carb   mpg   cyl  disp    hp  drat    wt  qsec    vs    am  cy12  cy14
&gt;&gt;    &lt;dbl&gt; &lt;dbl&gt; &lt;dbl&gt; &lt;dbl&gt; &lt;dbl&gt; &lt;dbl&gt; &lt;dbl&gt; &lt;dbl&gt; &lt;dbl&gt; &lt;dbl&gt; &lt;dbl&gt; &lt;dbl&gt; &lt;dbl&gt;
&gt;&gt;  1     4     4  21       6  160    110  3.9   2.62  16.5     0     1    12    24
&gt;&gt;  2     4     4  21       6  160    110  3.9   2.88  17.0     0     1    12    24
&gt;&gt;  3     4     1  22.8     4  108     93  3.85  2.32  18.6     1     1     8    16
&gt;&gt;  4     3     1  21.4     6  258    110  3.08  3.22  19.4     1     0    12    24
&gt;&gt;  5     3     2  18.7     8  360    175  3.15  3.44  17.0     0     0    16    32
&gt;&gt;  6     3     1  18.1     6  225    105  2.76  3.46  20.2     1     0    12    24
&gt;&gt;  7     3     4  14.3     8  360    245  3.21  3.57  15.8     0     0    16    32
&gt;&gt;  8     4     2  24.4     4  147.    62  3.69  3.19  20       1     0     8    16
&gt;&gt;  9     4     2  22.8     4  141.    95  3.92  3.15  22.9     1     0     8    16
&gt;&gt; 10     4     4  19.2     6  168.   123  3.92  3.44  18.3     1     0    12    24
&gt;&gt; # ... with 22 more rows

###to back
##先将要移动的列去掉，再重组到后面
to_back &lt;- c(&quot;mpg&quot;, &quot;cyl&quot;)
mtcars[c(setdiff(names(mtcars), to_back), to_back)]
&gt;&gt; # A tibble: 32 x 13
&gt;&gt;     disp    hp  drat    wt  qsec    vs    am  gear  carb  cy12  cy14   mpg   cyl
&gt;&gt;    &lt;dbl&gt; &lt;dbl&gt; &lt;dbl&gt; &lt;dbl&gt; &lt;dbl&gt; &lt;dbl&gt; &lt;dbl&gt; &lt;dbl&gt; &lt;dbl&gt; &lt;dbl&gt; &lt;dbl&gt; &lt;dbl&gt; &lt;dbl&gt;
&gt;&gt;  1  160    110  3.9   2.62  16.5     0     1     4     4    12    24  21       6
&gt;&gt;  2  160    110  3.9   2.88  17.0     0     1     4     4    12    24  21       6
&gt;&gt;  3  108     93  3.85  2.32  18.6     1     1     4     1     8    16  22.8     4
&gt;&gt;  4  258    110  3.08  3.22  19.4     1     0     3     1    12    24  21.4     6
&gt;&gt;  5  360    175  3.15  3.44  17.0     0     0     3     2    16    32  18.7     8
&gt;&gt;  6  225    105  2.76  3.46  20.2     1     0     3     1    12    24  18.1     6
&gt;&gt;  7  360    245  3.21  3.57  15.8     0     0     3     4    16    32  14.3     8
&gt;&gt;  8  147.    62  3.69  3.19  20       1     0     4     2     8    16  24.4     4
&gt;&gt;  9  141.    95  3.92  3.15  22.9     1     0     4     2     8    16  22.8     4
&gt;&gt; 10  168.   123  3.92  3.44  18.3     1     0     4     4    12    24  19.2     6
&gt;&gt; # ... with 22 more rows</code></pre>
</div>
<div id="rename-重命名变量" class="section level3">
<h3><code>rename()</code> 重命名变量</h3>
<p><code>dplyr::rename()</code>可以通过旧的名称或者位置来重命名变量：</p>
<pre class="r"><code>iris %&gt;% rename(sepal_length = Sepal.Length, sepal_width = 2)
&gt;&gt; # A tibble: 150 x 5
&gt;&gt;    sepal_length sepal_width Petal.Length Petal.Width Species
&gt;&gt;           &lt;dbl&gt;       &lt;dbl&gt;        &lt;dbl&gt;       &lt;dbl&gt; &lt;fct&gt;  
&gt;&gt;  1          5.1         3.5          1.4         0.2 setosa 
&gt;&gt;  2          4.9         3            1.4         0.2 setosa 
&gt;&gt;  3          4.7         3.2          1.3         0.2 setosa 
&gt;&gt;  4          4.6         3.1          1.5         0.2 setosa 
&gt;&gt;  5          5           3.6          1.4         0.2 setosa 
&gt;&gt;  6          5.4         3.9          1.7         0.4 setosa 
&gt;&gt;  7          4.6         3.4          1.4         0.3 setosa 
&gt;&gt;  8          5           3.4          1.5         0.2 setosa 
&gt;&gt;  9          4.4         2.9          1.4         0.2 setosa 
&gt;&gt; 10          4.9         3.1          1.5         0.1 setosa 
&gt;&gt; # ... with 140 more rows</code></pre>
<p>在base R中根据位置来重命名变量是比较直接的：</p>
<pre class="r"><code>iris2 &lt;- iris
names(iris2)[2] &lt;- &quot;sepal_width&quot;</code></pre>
<p>通过旧的变量名来重命名有一点繁琐：</p>
<pre class="r"><code>names(iris2)[names(iris2) == &quot;Sepal.Length&quot;] &lt;- &quot;sepal_length&quot;</code></pre>
</div>
<div id="rename_with通过函数来重命名变量" class="section level3">
<h3><code>rename_with()</code>通过函数来重命名变量</h3>
<p><code>dplyr::rename_with()</code>通过函数来转化列名：</p>
<pre class="r"><code>iris %&gt;% rename_with(toupper)
&gt;&gt; # A tibble: 150 x 5
&gt;&gt;    SEPAL.LENGTH SEPAL.WIDTH PETAL.LENGTH PETAL.WIDTH SPECIES
&gt;&gt;           &lt;dbl&gt;       &lt;dbl&gt;        &lt;dbl&gt;       &lt;dbl&gt; &lt;fct&gt;  
&gt;&gt;  1          5.1         3.5          1.4         0.2 setosa 
&gt;&gt;  2          4.9         3            1.4         0.2 setosa 
&gt;&gt;  3          4.7         3.2          1.3         0.2 setosa 
&gt;&gt;  4          4.6         3.1          1.5         0.2 setosa 
&gt;&gt;  5          5           3.6          1.4         0.2 setosa 
&gt;&gt;  6          5.4         3.9          1.7         0.4 setosa 
&gt;&gt;  7          4.6         3.4          1.4         0.3 setosa 
&gt;&gt;  8          5           3.4          1.5         0.2 setosa 
&gt;&gt;  9          4.4         2.9          1.4         0.2 setosa 
&gt;&gt; 10          4.9         3.1          1.5         0.1 setosa 
&gt;&gt; # ... with 140 more rows

###也可以选择范围，默认是所有列
rename_with(iris, toupper, starts_with(&quot;Petal&quot;))
&gt;&gt; # A tibble: 150 x 5
&gt;&gt;    Sepal.Length Sepal.Width PETAL.LENGTH PETAL.WIDTH Species
&gt;&gt;           &lt;dbl&gt;       &lt;dbl&gt;        &lt;dbl&gt;       &lt;dbl&gt; &lt;fct&gt;  
&gt;&gt;  1          5.1         3.5          1.4         0.2 setosa 
&gt;&gt;  2          4.9         3            1.4         0.2 setosa 
&gt;&gt;  3          4.7         3.2          1.3         0.2 setosa 
&gt;&gt;  4          4.6         3.1          1.5         0.2 setosa 
&gt;&gt;  5          5           3.6          1.4         0.2 setosa 
&gt;&gt;  6          5.4         3.9          1.7         0.4 setosa 
&gt;&gt;  7          4.6         3.4          1.4         0.3 setosa 
&gt;&gt;  8          5           3.4          1.5         0.2 setosa 
&gt;&gt;  9          4.4         2.9          1.4         0.2 setosa 
&gt;&gt; 10          4.9         3.1          1.5         0.1 setosa 
&gt;&gt; # ... with 140 more rows

###也可以自定义函数
rename_with(iris, function(x){
  gsub(&quot;.&quot;,&quot;_&quot;,x,fixed = TRUE)
  },starts_with(&quot;Petal&quot;))
&gt;&gt; # A tibble: 150 x 5
&gt;&gt;    Sepal.Length Sepal.Width Petal_Length Petal_Width Species
&gt;&gt;           &lt;dbl&gt;       &lt;dbl&gt;        &lt;dbl&gt;       &lt;dbl&gt; &lt;fct&gt;  
&gt;&gt;  1          5.1         3.5          1.4         0.2 setosa 
&gt;&gt;  2          4.9         3            1.4         0.2 setosa 
&gt;&gt;  3          4.7         3.2          1.3         0.2 setosa 
&gt;&gt;  4          4.6         3.1          1.5         0.2 setosa 
&gt;&gt;  5          5           3.6          1.4         0.2 setosa 
&gt;&gt;  6          5.4         3.9          1.7         0.4 setosa 
&gt;&gt;  7          4.6         3.4          1.4         0.3 setosa 
&gt;&gt;  8          5           3.4          1.5         0.2 setosa 
&gt;&gt;  9          4.4         2.9          1.4         0.2 setosa 
&gt;&gt; 10          4.9         3.1          1.5         0.1 setosa 
&gt;&gt; # ... with 140 more rows

###或者公式类型的函数
rename_with(iris, ~ tolower(gsub(&quot;.&quot;, &quot;_&quot;, .x, fixed = TRUE)))
&gt;&gt; # A tibble: 150 x 5
&gt;&gt;    sepal_length sepal_width petal_length petal_width species
&gt;&gt;           &lt;dbl&gt;       &lt;dbl&gt;        &lt;dbl&gt;       &lt;dbl&gt; &lt;fct&gt;  
&gt;&gt;  1          5.1         3.5          1.4         0.2 setosa 
&gt;&gt;  2          4.9         3            1.4         0.2 setosa 
&gt;&gt;  3          4.7         3.2          1.3         0.2 setosa 
&gt;&gt;  4          4.6         3.1          1.5         0.2 setosa 
&gt;&gt;  5          5           3.6          1.4         0.2 setosa 
&gt;&gt;  6          5.4         3.9          1.7         0.4 setosa 
&gt;&gt;  7          4.6         3.4          1.4         0.3 setosa 
&gt;&gt;  8          5           3.4          1.5         0.2 setosa 
&gt;&gt;  9          4.4         2.9          1.4         0.2 setosa 
&gt;&gt; 10          4.9         3.1          1.5         0.1 setosa 
&gt;&gt; # ... with 140 more rows</code></pre>
<p>在base R中可以使用<code>setNames()</code>来实现：</p>
<pre class="r"><code>setNames(iris, toupper(names(iris)))
&gt;&gt; # A tibble: 150 x 5
&gt;&gt;    SEPAL.LENGTH SEPAL.WIDTH PETAL.LENGTH PETAL.WIDTH SPECIES
&gt;&gt;           &lt;dbl&gt;       &lt;dbl&gt;        &lt;dbl&gt;       &lt;dbl&gt; &lt;fct&gt;  
&gt;&gt;  1          5.1         3.5          1.4         0.2 setosa 
&gt;&gt;  2          4.9         3            1.4         0.2 setosa 
&gt;&gt;  3          4.7         3.2          1.3         0.2 setosa 
&gt;&gt;  4          4.6         3.1          1.5         0.2 setosa 
&gt;&gt;  5          5           3.6          1.4         0.2 setosa 
&gt;&gt;  6          5.4         3.9          1.7         0.4 setosa 
&gt;&gt;  7          4.6         3.4          1.4         0.3 setosa 
&gt;&gt;  8          5           3.4          1.5         0.2 setosa 
&gt;&gt;  9          4.4         2.9          1.4         0.2 setosa 
&gt;&gt; 10          4.9         3.1          1.5         0.1 setosa 
&gt;&gt; # ... with 140 more rows</code></pre>
</div>
<div id="select通过列名选择变量" class="section level3">
<h3><code>select()</code>通过列名选择变量</h3>
<p><code>dplyr::select()</code>根据列名，位置，和列名相关的函数或者其他特征来选择列：</p>
<pre class="r"><code>###位置
iris %&gt;% select(1:3)
&gt;&gt; # A tibble: 150 x 3
&gt;&gt;    Sepal.Length Sepal.Width Petal.Length
&gt;&gt;           &lt;dbl&gt;       &lt;dbl&gt;        &lt;dbl&gt;
&gt;&gt;  1          5.1         3.5          1.4
&gt;&gt;  2          4.9         3            1.4
&gt;&gt;  3          4.7         3.2          1.3
&gt;&gt;  4          4.6         3.1          1.5
&gt;&gt;  5          5           3.6          1.4
&gt;&gt;  6          5.4         3.9          1.7
&gt;&gt;  7          4.6         3.4          1.4
&gt;&gt;  8          5           3.4          1.5
&gt;&gt;  9          4.4         2.9          1.4
&gt;&gt; 10          4.9         3.1          1.5
&gt;&gt; # ... with 140 more rows

##列名
iris %&gt;% select(Species, Sepal.Length)
&gt;&gt; # A tibble: 150 x 2
&gt;&gt;    Species Sepal.Length
&gt;&gt;    &lt;fct&gt;          &lt;dbl&gt;
&gt;&gt;  1 setosa           5.1
&gt;&gt;  2 setosa           4.9
&gt;&gt;  3 setosa           4.7
&gt;&gt;  4 setosa           4.6
&gt;&gt;  5 setosa           5  
&gt;&gt;  6 setosa           5.4
&gt;&gt;  7 setosa           4.6
&gt;&gt;  8 setosa           5  
&gt;&gt;  9 setosa           4.4
&gt;&gt; 10 setosa           4.9
&gt;&gt; # ... with 140 more rows

##函数
iris %&gt;% select(starts_with(&quot;Petal&quot;))
&gt;&gt; # A tibble: 150 x 2
&gt;&gt;    Petal.Length Petal.Width
&gt;&gt;           &lt;dbl&gt;       &lt;dbl&gt;
&gt;&gt;  1          1.4         0.2
&gt;&gt;  2          1.4         0.2
&gt;&gt;  3          1.3         0.2
&gt;&gt;  4          1.5         0.2
&gt;&gt;  5          1.4         0.2
&gt;&gt;  6          1.7         0.4
&gt;&gt;  7          1.4         0.3
&gt;&gt;  8          1.5         0.2
&gt;&gt;  9          1.4         0.2
&gt;&gt; 10          1.5         0.1
&gt;&gt; # ... with 140 more rows
iris %&gt;% select(where(is.factor))
&gt;&gt; # A tibble: 150 x 1
&gt;&gt;    Species
&gt;&gt;    &lt;fct&gt;  
&gt;&gt;  1 setosa 
&gt;&gt;  2 setosa 
&gt;&gt;  3 setosa 
&gt;&gt;  4 setosa 
&gt;&gt;  5 setosa 
&gt;&gt;  6 setosa 
&gt;&gt;  7 setosa 
&gt;&gt;  8 setosa 
&gt;&gt;  9 setosa 
&gt;&gt; 10 setosa 
&gt;&gt; # ... with 140 more rows</code></pre>
<p>在base R中通过位置选择变量是比较直接的:</p>
<pre class="r"><code>iris[1:3]##单个参数是取列的
&gt;&gt; # A tibble: 150 x 3
&gt;&gt;    Sepal.Length Sepal.Width Petal.Length
&gt;&gt;           &lt;dbl&gt;       &lt;dbl&gt;        &lt;dbl&gt;
&gt;&gt;  1          5.1         3.5          1.4
&gt;&gt;  2          4.9         3            1.4
&gt;&gt;  3          4.7         3.2          1.3
&gt;&gt;  4          4.6         3.1          1.5
&gt;&gt;  5          5           3.6          1.4
&gt;&gt;  6          5.4         3.9          1.7
&gt;&gt;  7          4.6         3.4          1.4
&gt;&gt;  8          5           3.4          1.5
&gt;&gt;  9          4.4         2.9          1.4
&gt;&gt; 10          4.9         3.1          1.5
&gt;&gt; # ... with 140 more rows

iris[1:3, , drop = FALSE]##也可以加多个参数，第二个参数是列
&gt;&gt; # A tibble: 3 x 5
&gt;&gt;   Sepal.Length Sepal.Width Petal.Length Petal.Width Species
&gt;&gt;          &lt;dbl&gt;       &lt;dbl&gt;        &lt;dbl&gt;       &lt;dbl&gt; &lt;fct&gt;  
&gt;&gt; 1          5.1         3.5          1.4         0.2 setosa 
&gt;&gt; 2          4.9         3            1.4         0.2 setosa 
&gt;&gt; 3          4.7         3.2          1.3         0.2 setosa</code></pre>
<p>按照名称选择列可以有两种选择：</p>
<pre class="r"><code>###直接按照字符向量选择
iris[c(&quot;Species&quot;, &quot;Sepal.Length&quot;)]
&gt;&gt; # A tibble: 150 x 2
&gt;&gt;    Species Sepal.Length
&gt;&gt;    &lt;fct&gt;          &lt;dbl&gt;
&gt;&gt;  1 setosa           5.1
&gt;&gt;  2 setosa           4.9
&gt;&gt;  3 setosa           4.7
&gt;&gt;  4 setosa           4.6
&gt;&gt;  5 setosa           5  
&gt;&gt;  6 setosa           5.4
&gt;&gt;  7 setosa           4.6
&gt;&gt;  8 setosa           5  
&gt;&gt;  9 setosa           4.4
&gt;&gt; 10 setosa           4.9
&gt;&gt; # ... with 140 more rows

###使用subset函数，subset使用了和dplyr相同的机制(元编程)
subset(iris, select = c(Species, Sepal.Length))
&gt;&gt; # A tibble: 150 x 2
&gt;&gt;    Species Sepal.Length
&gt;&gt;    &lt;fct&gt;          &lt;dbl&gt;
&gt;&gt;  1 setosa           5.1
&gt;&gt;  2 setosa           4.9
&gt;&gt;  3 setosa           4.7
&gt;&gt;  4 setosa           4.6
&gt;&gt;  5 setosa           5  
&gt;&gt;  6 setosa           5.4
&gt;&gt;  7 setosa           4.6
&gt;&gt;  8 setosa           5  
&gt;&gt;  9 setosa           4.4
&gt;&gt; 10 setosa           4.9
&gt;&gt; # ... with 140 more rows</code></pre>
<p>通过名称的函数来选择列，可以使用<code>grep</code>函数来匹配：</p>
<pre class="r"><code>iris[grep(&quot;^Petal&quot;, names(iris))]
&gt;&gt; # A tibble: 150 x 2
&gt;&gt;    Petal.Length Petal.Width
&gt;&gt;           &lt;dbl&gt;       &lt;dbl&gt;
&gt;&gt;  1          1.4         0.2
&gt;&gt;  2          1.4         0.2
&gt;&gt;  3          1.3         0.2
&gt;&gt;  4          1.5         0.2
&gt;&gt;  5          1.4         0.2
&gt;&gt;  6          1.7         0.4
&gt;&gt;  7          1.4         0.3
&gt;&gt;  8          1.5         0.2
&gt;&gt;  9          1.4         0.2
&gt;&gt; 10          1.5         0.1
&gt;&gt; # ... with 140 more rows</code></pre>
<p>也可以通过Filter函数根据变量的类型来选择列：Filter是高阶函数，接受别的函数作为参数，高阶函数的内容见<a href="https://wutaoblog.com.cn/p/meta_r_prom/">review</a></p>
<pre class="r"><code>###
Filter(is.factor,iris)
&gt;&gt; # A tibble: 150 x 1
&gt;&gt;    Species
&gt;&gt;    &lt;fct&gt;  
&gt;&gt;  1 setosa 
&gt;&gt;  2 setosa 
&gt;&gt;  3 setosa 
&gt;&gt;  4 setosa 
&gt;&gt;  5 setosa 
&gt;&gt;  6 setosa 
&gt;&gt;  7 setosa 
&gt;&gt;  8 setosa 
&gt;&gt;  9 setosa 
&gt;&gt; 10 setosa 
&gt;&gt; # ... with 140 more rows</code></pre>
</div>
<div id="summarise将多个值汇总成单个值" class="section level3">
<h3><code>summarise()</code>将多个值汇总成单个值</h3>
<p><code>dplyr::summarise</code> 计算每个组别的汇总信息：</p>
<pre class="r"><code>mtcars %&gt;% 
  group_by(cyl) %&gt;% 
  summarise(mean = mean(disp), n = n())
&gt;&gt; `summarise()` ungrouping output (override with `.groups` argument)
&gt;&gt; # A tibble: 3 x 3
&gt;&gt;     cyl  mean     n
&gt;&gt;   &lt;dbl&gt; &lt;dbl&gt; &lt;int&gt;
&gt;&gt; 1     4  105.    11
&gt;&gt; 2     6  183.     7
&gt;&gt; 3     8  353.    14</code></pre>
<p>在base R里面比较相似的是by函数，但是by函数返回的是list：</p>
<pre class="r"><code>###先来看一下by函数的用法
##by(data, data$byvar, FUN)
##data是数据，data$byvar是分组依据，fun是函数


mtcars_by &lt;- by(mtcars, mtcars$cyl, function(df) {
  with(df, data.frame(cyl = cyl[[1]], mean = mean(disp), n = nrow(df)))
})
mtcars_by
&gt;&gt; mtcars$cyl: 4
&gt;&gt;   cyl     mean  n
&gt;&gt; 1   4 105.1364 11
&gt;&gt; ------------------------------------------------------------ 
&gt;&gt; mtcars$cyl: 6
&gt;&gt;   cyl     mean n
&gt;&gt; 1   6 183.3143 7
&gt;&gt; ------------------------------------------------------------ 
&gt;&gt; mtcars$cyl: 8
&gt;&gt;   cyl  mean  n
&gt;&gt; 1   8 353.1 14</code></pre>
<p>我们可以使用<a href="">do.call函数</a>来将这个列表合并成数据框：</p>
<pre class="r"><code>do.call(rbind,mtcars_by)
&gt;&gt;   cyl     mean  n
&gt;&gt; 4   4 105.1364 11
&gt;&gt; 6   6 183.3143  7
&gt;&gt; 8   8 353.1000 14</code></pre>
</div>
<div id="slice-根据位置选择行" class="section level3">
<h3><code>slice()</code> 根据位置选择行</h3>
<pre class="r"><code>###n表示行数
slice(mtcars, 25:n())
&gt;&gt; # A tibble: 8 x 13
&gt;&gt;     mpg   cyl  disp    hp  drat    wt  qsec    vs    am  gear  carb  cy12  cy14
&gt;&gt;   &lt;dbl&gt; &lt;dbl&gt; &lt;dbl&gt; &lt;dbl&gt; &lt;dbl&gt; &lt;dbl&gt; &lt;dbl&gt; &lt;dbl&gt; &lt;dbl&gt; &lt;dbl&gt; &lt;dbl&gt; &lt;dbl&gt; &lt;dbl&gt;
&gt;&gt; 1  19.2     8 400     175  3.08  3.84  17.0     0     0     3     2    16    32
&gt;&gt; 2  27.3     4  79      66  4.08  1.94  18.9     1     1     4     1     8    16
&gt;&gt; 3  26       4 120.     91  4.43  2.14  16.7     0     1     5     2     8    16
&gt;&gt; 4  30.4     4  95.1   113  3.77  1.51  16.9     1     1     5     2     8    16
&gt;&gt; 5  15.8     8 351     264  4.22  3.17  14.5     0     1     5     4    16    32
&gt;&gt; 6  19.7     6 145     175  3.62  2.77  15.5     0     1     5     6    12    24
&gt;&gt; 7  15       8 301     335  3.54  3.57  14.6     0     1     5     8    16    32
&gt;&gt; 8  21.4     4 121     109  4.11  2.78  18.6     1     1     4     2     8    16</code></pre>
<p>在base R中可以直接使用[来选取：</p>
<pre class="r"><code>mtcars[25:nrow(mtcars), , drop = FALSE]
&gt;&gt; # A tibble: 8 x 13
&gt;&gt;     mpg   cyl  disp    hp  drat    wt  qsec    vs    am  gear  carb  cy12  cy14
&gt;&gt;   &lt;dbl&gt; &lt;dbl&gt; &lt;dbl&gt; &lt;dbl&gt; &lt;dbl&gt; &lt;dbl&gt; &lt;dbl&gt; &lt;dbl&gt; &lt;dbl&gt; &lt;dbl&gt; &lt;dbl&gt; &lt;dbl&gt; &lt;dbl&gt;
&gt;&gt; 1  19.2     8 400     175  3.08  3.84  17.0     0     0     3     2    16    32
&gt;&gt; 2  27.3     4  79      66  4.08  1.94  18.9     1     1     4     1     8    16
&gt;&gt; 3  26       4 120.     91  4.43  2.14  16.7     0     1     5     2     8    16
&gt;&gt; 4  30.4     4  95.1   113  3.77  1.51  16.9     1     1     5     2     8    16
&gt;&gt; 5  15.8     8 351     264  4.22  3.17  14.5     0     1     5     4    16    32
&gt;&gt; 6  19.7     6 145     175  3.62  2.77  15.5     0     1     5     6    12    24
&gt;&gt; 7  15       8 301     335  3.54  3.57  14.6     0     1     5     8    16    32
&gt;&gt; 8  21.4     4 121     109  4.11  2.78  18.6     1     1     4     2     8    16</code></pre>
</div>
</div>
<div id="two-table-verbs" class="section level2">
<h2>Two-table verbs</h2>
<p>增加：<a href="https://github.com/tidyverse/dplyr/blob/master/vignettes/two-table.Rmd">two-table</a></p>
<p>two-table verbs指的是合并两个数据框的操作，在dplyr中使用*_join操作代替base R中的各种merge操作：</p>
<table>
<thead>
<tr class="header">
<th>dplyr</th>
<th>base</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td><code>inner_join(df1, df2)</code></td>
<td><code>merge(df1, df2)</code></td>
</tr>
<tr class="even">
<td><code>left_join(df1, df2)</code></td>
<td><code>merge(df1, df2, all.x = TRUE)</code></td>
</tr>
<tr class="odd">
<td><code>right_join(df1, df2)</code></td>
<td><code>merge(df1, df2, all.y = TRUE)</code></td>
</tr>
<tr class="even">
<td><code>full_join(df1, df2)</code></td>
<td><code>merge(df1, df2, all = TRUE)</code></td>
</tr>
<tr class="odd">
<td><code>semi_join(df1, df2)</code></td>
<td><code>df1[df1$x %in% df2$x, , drop = FALSE]</code></td>
</tr>
<tr class="even">
<td><code>anti_join(df1, df2)</code></td>
<td><code>df1[!df1$x %in% df2$x, , drop = FALSE]</code></td>
</tr>
</tbody>
</table>
<p>在dplyr中有3类动词可以同时对两个table进行操作：</p>
<ul>
<li><p>Mutating join 根据匹配的行来添加变量</p></li>
<li><p>Filtering joins 根据匹配的行来筛选变量</p></li>
<li><p>Set operations 将数据集的行作为集合的元素来操作</p></li>
</ul>
<div id="mutating-joins" class="section level3">
<h3>Mutating joins</h3>
<p>Mutating join可以将两个table的变量结合到一起；比如在nycflights13数据中一个table有航班信息，并且每个航班有相应的航空公司的缩写，另一个table有航空公司的缩写和全称的对应信息，我们可以将这两个table合并：</p>
<pre class="r"><code>library(&quot;nycflights13&quot;)

flights2 &lt;- flights %&gt;% select(year:day, hour, origin, dest, tailnum, carrier)

flights2 %&gt;% 
  left_join(airlines)
&gt;&gt; Joining, by = &quot;carrier&quot;
&gt;&gt; # A tibble: 336,776 x 9
&gt;&gt;     year month   day  hour origin dest  tailnum carrier name                    
&gt;&gt;    &lt;int&gt; &lt;int&gt; &lt;int&gt; &lt;dbl&gt; &lt;chr&gt;  &lt;chr&gt; &lt;chr&gt;   &lt;chr&gt;   &lt;chr&gt;                   
&gt;&gt;  1  2013     1     1     5 EWR    IAH   N14228  UA      United Air Lines Inc.   
&gt;&gt;  2  2013     1     1     5 LGA    IAH   N24211  UA      United Air Lines Inc.   
&gt;&gt;  3  2013     1     1     5 JFK    MIA   N619AA  AA      American Airlines Inc.  
&gt;&gt;  4  2013     1     1     5 JFK    BQN   N804JB  B6      JetBlue Airways         
&gt;&gt;  5  2013     1     1     6 LGA    ATL   N668DN  DL      Delta Air Lines Inc.    
&gt;&gt;  6  2013     1     1     5 EWR    ORD   N39463  UA      United Air Lines Inc.   
&gt;&gt;  7  2013     1     1     6 EWR    FLL   N516JB  B6      JetBlue Airways         
&gt;&gt;  8  2013     1     1     6 LGA    IAD   N829AS  EV      ExpressJet Airlines Inc.
&gt;&gt;  9  2013     1     1     6 JFK    MCO   N593JB  B6      JetBlue Airways         
&gt;&gt; 10  2013     1     1     6 LGA    ORD   N3ALAA  AA      American Airlines Inc.  
&gt;&gt; # ... with 336,766 more rows</code></pre>
<div id="控制table如何匹配" class="section level4">
<h4>控制table如何匹配</h4>
<p>每一个Mutating join函数都有一个by参数，控制哪个变量被用来进行匹配</p>
<ul>
<li><p><code>NULL</code> 默认值，使用两个table中共有的变量，比如flights和weather两个表的共有列为year, month, day, hour 和origin</p>
<pre class="r"><code>flights2 %&gt;% left_join(weather)
&gt;&gt; Joining, by = c(&quot;year&quot;, &quot;month&quot;, &quot;day&quot;, &quot;hour&quot;, &quot;origin&quot;)
&gt;&gt; # A tibble: 336,776 x 18
&gt;&gt;     year month   day  hour origin dest  tailnum carrier  temp  dewp humid
&gt;&gt;    &lt;int&gt; &lt;int&gt; &lt;int&gt; &lt;dbl&gt; &lt;chr&gt;  &lt;chr&gt; &lt;chr&gt;   &lt;chr&gt;   &lt;dbl&gt; &lt;dbl&gt; &lt;dbl&gt;
&gt;&gt;  1  2013     1     1     5 EWR    IAH   N14228  UA       39.0  28.0  64.4
&gt;&gt;  2  2013     1     1     5 LGA    IAH   N24211  UA       39.9  25.0  54.8
&gt;&gt;  3  2013     1     1     5 JFK    MIA   N619AA  AA       39.0  27.0  61.6
&gt;&gt;  4  2013     1     1     5 JFK    BQN   N804JB  B6       39.0  27.0  61.6
&gt;&gt;  5  2013     1     1     6 LGA    ATL   N668DN  DL       39.9  25.0  54.8
&gt;&gt;  6  2013     1     1     5 EWR    ORD   N39463  UA       39.0  28.0  64.4
&gt;&gt;  7  2013     1     1     6 EWR    FLL   N516JB  B6       37.9  28.0  67.2
&gt;&gt;  8  2013     1     1     6 LGA    IAD   N829AS  EV       39.9  25.0  54.8
&gt;&gt;  9  2013     1     1     6 JFK    MCO   N593JB  B6       37.9  27.0  64.3
&gt;&gt; 10  2013     1     1     6 LGA    ORD   N3ALAA  AA       39.9  25.0  54.8
&gt;&gt; # ... with 336,766 more rows, and 7 more variables: wind_dir &lt;dbl&gt;,
&gt;&gt; #   wind_speed &lt;dbl&gt;, wind_gust &lt;dbl&gt;, precip &lt;dbl&gt;, pressure &lt;dbl&gt;,
&gt;&gt; #   visib &lt;dbl&gt;, time_hour &lt;dttm&gt;</code></pre></li>
<li><p>字符向量，<code>by="x"</code> 使用指定的变量进行匹配</p>
<pre class="r"><code>flights2 %&gt;% left_join(planes, by = &quot;tailnum&quot;)
&gt;&gt; # A tibble: 336,776 x 16
&gt;&gt;    year.x month   day  hour origin dest  tailnum carrier year.y type 
&gt;&gt;     &lt;int&gt; &lt;int&gt; &lt;int&gt; &lt;dbl&gt; &lt;chr&gt;  &lt;chr&gt; &lt;chr&gt;   &lt;chr&gt;    &lt;int&gt; &lt;chr&gt;
&gt;&gt;  1   2013     1     1     5 EWR    IAH   N14228  UA        1999 Fixe~
&gt;&gt;  2   2013     1     1     5 LGA    IAH   N24211  UA        1998 Fixe~
&gt;&gt;  3   2013     1     1     5 JFK    MIA   N619AA  AA        1990 Fixe~
&gt;&gt;  4   2013     1     1     5 JFK    BQN   N804JB  B6        2012 Fixe~
&gt;&gt;  5   2013     1     1     6 LGA    ATL   N668DN  DL        1991 Fixe~
&gt;&gt;  6   2013     1     1     5 EWR    ORD   N39463  UA        2012 Fixe~
&gt;&gt;  7   2013     1     1     6 EWR    FLL   N516JB  B6        2000 Fixe~
&gt;&gt;  8   2013     1     1     6 LGA    IAD   N829AS  EV        1998 Fixe~
&gt;&gt;  9   2013     1     1     6 JFK    MCO   N593JB  B6        2004 Fixe~
&gt;&gt; 10   2013     1     1     6 LGA    ORD   N3ALAA  AA          NA &lt;NA&gt; 
&gt;&gt; # ... with 336,766 more rows, and 6 more variables: manufacturer &lt;chr&gt;,
&gt;&gt; #   model &lt;chr&gt;, engines &lt;int&gt;, seats &lt;int&gt;, speed &lt;int&gt;, engine &lt;chr&gt;

##两个table的其他的共有列会加上后缀</code></pre></li>
<li><p>具名字符向量，<code>by=c("a"="b")</code> 将一个table中的a变量与另一个table中的b变量进行匹配(输出中保留a)</p>
<pre class="r"><code>flights2 %&gt;% left_join(airports, c(&quot;dest&quot; = &quot;faa&quot;))
&gt;&gt; # A tibble: 336,776 x 15
&gt;&gt;     year month   day  hour origin dest  tailnum carrier name    lat   lon   alt
&gt;&gt;    &lt;int&gt; &lt;int&gt; &lt;int&gt; &lt;dbl&gt; &lt;chr&gt;  &lt;chr&gt; &lt;chr&gt;   &lt;chr&gt;   &lt;chr&gt; &lt;dbl&gt; &lt;dbl&gt; &lt;dbl&gt;
&gt;&gt;  1  2013     1     1     5 EWR    IAH   N14228  UA      Geor~  30.0 -95.3    97
&gt;&gt;  2  2013     1     1     5 LGA    IAH   N24211  UA      Geor~  30.0 -95.3    97
&gt;&gt;  3  2013     1     1     5 JFK    MIA   N619AA  AA      Miam~  25.8 -80.3     8
&gt;&gt;  4  2013     1     1     5 JFK    BQN   N804JB  B6      &lt;NA&gt;   NA    NA      NA
&gt;&gt;  5  2013     1     1     6 LGA    ATL   N668DN  DL      Hart~  33.6 -84.4  1026
&gt;&gt;  6  2013     1     1     5 EWR    ORD   N39463  UA      Chic~  42.0 -87.9   668
&gt;&gt;  7  2013     1     1     6 EWR    FLL   N516JB  B6      Fort~  26.1 -80.2     9
&gt;&gt;  8  2013     1     1     6 LGA    IAD   N829AS  EV      Wash~  38.9 -77.5   313
&gt;&gt;  9  2013     1     1     6 JFK    MCO   N593JB  B6      Orla~  28.4 -81.3    96
&gt;&gt; 10  2013     1     1     6 LGA    ORD   N3ALAA  AA      Chic~  42.0 -87.9   668
&gt;&gt; # ... with 336,766 more rows, and 3 more variables: tz &lt;dbl&gt;, dst &lt;chr&gt;,
&gt;&gt; #   tzone &lt;chr&gt;

flights2 %&gt;% left_join(airports, c(&quot;origin&quot; = &quot;faa&quot;))
&gt;&gt; # A tibble: 336,776 x 15
&gt;&gt;     year month   day  hour origin dest  tailnum carrier name    lat   lon   alt
&gt;&gt;    &lt;int&gt; &lt;int&gt; &lt;int&gt; &lt;dbl&gt; &lt;chr&gt;  &lt;chr&gt; &lt;chr&gt;   &lt;chr&gt;   &lt;chr&gt; &lt;dbl&gt; &lt;dbl&gt; &lt;dbl&gt;
&gt;&gt;  1  2013     1     1     5 EWR    IAH   N14228  UA      Newa~  40.7 -74.2    18
&gt;&gt;  2  2013     1     1     5 LGA    IAH   N24211  UA      La G~  40.8 -73.9    22
&gt;&gt;  3  2013     1     1     5 JFK    MIA   N619AA  AA      John~  40.6 -73.8    13
&gt;&gt;  4  2013     1     1     5 JFK    BQN   N804JB  B6      John~  40.6 -73.8    13
&gt;&gt;  5  2013     1     1     6 LGA    ATL   N668DN  DL      La G~  40.8 -73.9    22
&gt;&gt;  6  2013     1     1     5 EWR    ORD   N39463  UA      Newa~  40.7 -74.2    18
&gt;&gt;  7  2013     1     1     6 EWR    FLL   N516JB  B6      Newa~  40.7 -74.2    18
&gt;&gt;  8  2013     1     1     6 LGA    IAD   N829AS  EV      La G~  40.8 -73.9    22
&gt;&gt;  9  2013     1     1     6 JFK    MCO   N593JB  B6      John~  40.6 -73.8    13
&gt;&gt; 10  2013     1     1     6 LGA    ORD   N3ALAA  AA      La G~  40.8 -73.9    22
&gt;&gt; # ... with 336,766 more rows, and 3 more variables: tz &lt;dbl&gt;, dst &lt;chr&gt;,
&gt;&gt; #   tzone &lt;chr&gt;</code></pre></li>
</ul>
</div>
<div id="匹配的类型" class="section level4">
<h4>匹配的类型</h4>
<p>有4种类型的mutating join，他们的区别在于如何处理找不到匹配的情况</p>
<pre class="r"><code>##示例数据
df1 &lt;- tibble(x = c(1, 2), y = 2:1)
df2 &lt;- tibble(x = c(3, 1), a = 10, b = &quot;a&quot;)

df1
&gt;&gt; # A tibble: 2 x 2
&gt;&gt;       x     y
&gt;&gt;   &lt;dbl&gt; &lt;int&gt;
&gt;&gt; 1     1     2
&gt;&gt; 2     2     1

df2
&gt;&gt; # A tibble: 2 x 3
&gt;&gt;       x     a b    
&gt;&gt;   &lt;dbl&gt; &lt;dbl&gt; &lt;chr&gt;
&gt;&gt; 1     3    10 a    
&gt;&gt; 2     1    10 a</code></pre>
<ul>
<li><p><code>inner_join(x,y)</code> 只包含x和y中都有的行</p>
<pre class="r"><code>df1 %&gt;% inner_join(df2)
&gt;&gt; Joining, by = &quot;x&quot;
&gt;&gt; # A tibble: 1 x 4
&gt;&gt;       x     y     a b    
&gt;&gt;   &lt;dbl&gt; &lt;int&gt; &lt;dbl&gt; &lt;chr&gt;
&gt;&gt; 1     1     2    10 a</code></pre></li>
<li><p><code>left_join(x,y)</code> 包含x的所有行，不管有没有匹配(没有匹配的为NA)</p>
<pre class="r"><code>df1 %&gt;% left_join(df2)
&gt;&gt; Joining, by = &quot;x&quot;
&gt;&gt; # A tibble: 2 x 4
&gt;&gt;       x     y     a b    
&gt;&gt;   &lt;dbl&gt; &lt;int&gt; &lt;dbl&gt; &lt;chr&gt;
&gt;&gt; 1     1     2    10 a    
&gt;&gt; 2     2     1    NA &lt;NA&gt;</code></pre></li>
<li><p><code>right_join(x,y)</code> 包含y的所有行(和<code>left_join(y,x)</code> 的差别在于行和列的顺序不一样)</p>
<pre class="r"><code>df1 %&gt;% right_join(df2)
&gt;&gt; Joining, by = &quot;x&quot;
&gt;&gt; # A tibble: 2 x 4
&gt;&gt;       x     y     a b    
&gt;&gt;   &lt;dbl&gt; &lt;int&gt; &lt;dbl&gt; &lt;chr&gt;
&gt;&gt; 1     1     2    10 a    
&gt;&gt; 2     3    NA    10 a

df2 %&gt;% left_join(df1)
&gt;&gt; Joining, by = &quot;x&quot;
&gt;&gt; # A tibble: 2 x 4
&gt;&gt;       x     a b         y
&gt;&gt;   &lt;dbl&gt; &lt;dbl&gt; &lt;chr&gt; &lt;int&gt;
&gt;&gt; 1     3    10 a        NA
&gt;&gt; 2     1    10 a         2</code></pre></li>
<li><p><code>full_join(x,y)</code> 包含x和y的所有行</p>
<pre class="r"><code>df1 %&gt;% full_join(df2)
&gt;&gt; Joining, by = &quot;x&quot;
&gt;&gt; # A tibble: 3 x 4
&gt;&gt;       x     y     a b    
&gt;&gt;   &lt;dbl&gt; &lt;int&gt; &lt;dbl&gt; &lt;chr&gt;
&gt;&gt; 1     1     2    10 a    
&gt;&gt; 2     2     1    NA &lt;NA&gt; 
&gt;&gt; 3     3    NA    10 a</code></pre></li>
</ul>
<p>需要注意的一点是：如果匹配不唯一(比如x里面用来匹配的变量有几行是一样的)，那么进行join时会加上所有可能的组合(笛卡尔积)：</p>
<pre class="r"><code>df1 &lt;- tibble(x = c(1, 1, 2), y = 1:3)
df2 &lt;- tibble(x = c(1, 1, 2), z = c(&quot;a&quot;, &quot;b&quot;, &quot;a&quot;))
df1 %&gt;% left_join(df2)
&gt;&gt; Joining, by = &quot;x&quot;
&gt;&gt; # A tibble: 5 x 3
&gt;&gt;       x     y z    
&gt;&gt;   &lt;dbl&gt; &lt;int&gt; &lt;chr&gt;
&gt;&gt; 1     1     1 a    
&gt;&gt; 2     1     1 b    
&gt;&gt; 3     1     2 a    
&gt;&gt; 4     1     2 b    
&gt;&gt; 5     2     3 a</code></pre>
</div>
</div>
<div id="filtering-joins" class="section level3">
<h3>Filtering joins</h3>
<p>filter join影响的是观测不是变量，有两种类型：</p>
<ul>
<li><p><code>semi_join(x,y)</code> 保留x在y中有匹配的观测</p></li>
<li><p><code>anti_join(x,y)</code> 丢弃x在y中有匹配的观测</p></li>
</ul>
</div>
</div>
